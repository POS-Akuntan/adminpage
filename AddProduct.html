<!DOCTYPE html> 
<html lang="en">
  <!-- huh -->
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Add New Product</title>
    <link rel="stylesheet" href="static/css/add_product.css" />
  </head>
  <body>
    <div class="container">
      <h1>Add New Product</h1>
      <form id="add-product-form">
        <label for="product-name">Name Product:</label>
        <input type="text" id="product-name" required />

        <label for="product-price">Price:</label>
        <input type="number" id="product-price" required />

        <label for="product-category_name">Category:</label>
        <!-- Dropdown untuk kategori -->
        <select id="product-category_name" required>
          <!-- Opsi kategori akan dimasukkan di sini secara dinamis -->
        </select>

        <label for="product-description">Description:</label>
        <input type="text" id="product-description" required />

        <label for="product-stock">Stock:</label>
        <input type="number" id="product-stock" required />

        <button type="submit">Add Product</button>
      </form>

      <button class="back-btn" id="backToProductBtn">
        Back to Product Page
      </button>
    </div>

    <script type="module">
      // Import SweetAlert2 dan CSS
      import Swal from "https://cdn.jsdelivr.net/npm/sweetalert2@11/src/sweetalert2.js";
      import { addCSS } from "https://cdn.jsdelivr.net/gh/jscroot/lib@0.0.9/element.js";

      addCSS("https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.css");

      // Fungsi untuk mengambil kategori produk
      const fetchCategories = async () => {
        try {
          const response = await fetch("https://pos-ochre.vercel.app/api/categories"); // Ganti dengan API yang sesuai
          const categories = await response.json();

          // Isi dropdown kategori dengan data kategori
          const categorySelect = document.getElementById("product-category_name");
          categories.forEach(category => {
            const option = document.createElement("option");
            option.value = category.id;  // Pastikan field ID dan Name sesuai
            option.textContent = category.name;
            categorySelect.appendChild(option);
          });
        } catch (error) {
          console.error("Error fetching categories:", error);
          Swal.fire({
            icon: "error",
            title: "Failed to load categories",
            text: "There was an error loading the categories. Please try again."
          });
        }
      };

      // Muat kategori saat halaman dimuat
      window.onload = fetchCategories;

      // Menangani form submit
      document
        .getElementById("add-product-form")
        .addEventListener("submit", async function (event) {
          event.preventDefault();

          // Ambil nilai form
          const productName = document.getElementById("product-name").value;
          const productPrice = parseFloat(
            document.getElementById("product-price").value
          );
          const productCategoryId = document.getElementById("product-category_name").value;
          const productDescription = document.getElementById("product-description").value;
          const productStock = parseInt(
            document.getElementById("product-stock").value,
            10
          );

          // Buat objek produk baru
          const newProduct = {
            name: productName,
            price: productPrice,
            category_id: productCategoryId,  // Gunakan category_id jika kategori di API berdasarkan ID
            description: productDescription,
            stock: productStock,
          };

          // Tampilkan konfirmasi sebelum menambah produk
          const result = await Swal.fire({
            icon: "warning",
            title: "Are you sure you want to add this product?",
            showCancelButton: true,
            confirmButtonText: "Yes, add it!",
            cancelButtonText: "No, keep editing",
          });

          if (result.isConfirmed) {
            try {
              const response = await fetch(
                "https://pos-ochre.vercel.app/api/products",
                {
                  method: "POST",
                  headers: { "Content-Type": "application/json" },
                  body: JSON.stringify(newProduct),
                }
              );

              if (response.ok) {
                // Tampilkan pesan sukses
                await Swal.fire({
                  icon: "success",
                  title: "Added",
                  text: "Product added successfully!",
                });
                window.location.href = "Product.html";
              } else {
                const errorText = await response.text();
                Swal.fire({
                  icon: "error",
                  title: "Add Failed",
                  text: `Failed to add product: ${errorText}`,
                });
              }
            } catch (error) {
              console.error("Error:", error);
              Swal.fire({
                icon: "error",
                title: "Error",
                text: "An error occurred. Please try again.",
              });
            }
          }
        });

      document
        .getElementById("backToProductBtn")
        .addEventListener("click", function () {
          window.location.href = "Product.html";
        });
    </script>
  </body>
</html>
